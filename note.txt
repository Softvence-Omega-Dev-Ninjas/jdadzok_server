This document provides a comprehensive guide for implementing real-time chat functionality using WebSocket and REST API endpoints.

üîå Connection Details
WebSocket Endpoint: ws://localhost:5056/chat
Authentication: JWT token required in socket connection
or Authorization header: Bearer {token}

üì° WebSocket Events
1. Send Message
Event: chat:message_send
Payload:
typescript{
  receiverId: string;      // UUID of the recipient
  content: string;         // Message text content
  mediaUrl?: string;       // Optional: URL for media (image/video/file)
  mediaType?: string;      // Optional: "IMAGE" | "VIDEO" | "FILE" | "AUDIO"
}
Example:
typescriptsocket.emit('chat:message_send', {
  receiverId: "e5540097-91db-4198-9e6c-851e340365ca",
  content: "Hey! How are you doing today?",
  mediaUrl: "https://example.com/image.jpg",
  mediaType: "IMAGE"
});

2. Receive Message (as recipient)
Event: chat:message_receive
Payload Structure:
typescript{
  id: string;              // Message ID
  chatId: string;          // Chat room ID
  content: string;         // Message content
  mediaUrl: string | null; // Media URL if present
  mediaType: string | null;// Media type if present
  sender: {
    id: string;
    email: string;
    role: string;
    isVerified: boolean;
    profile: {
      name: string;
      avatarUrl: string | null;
    } | null;
  };
  receiver: {
    id: string;
    email: string;
    role: string;
    isVerified: boolean;
    profile: {
      name: string;
      avatarUrl: string | null;
    } | null;
  };
  createdAt: string;       // ISO 8601 timestamp
}
Listen for incoming messages:
typescriptsocket.on('chat:message_receive', (message) => {
  console.log('New message received:', message);
  // Update your chat UI with the new message
});

3. Message Sent Confirmation (as sender)
Event: chat:message_sent
Same payload structure as chat:message_receive. This confirms your message was successfully sent.
typescriptsocket.on('chat:message_sent', (message) => {
  console.log('Message sent successfully:', message);
  // Update UI to show message as sent
});

4. Mark Message as Read
Event: chat:message_read
Send:
typescriptsocket.emit('chat:message_read', {
  messageId: "754dc40f-7f10-40df-8375-a3f057a8ad42"
});
Receive (read receipt):
typescriptsocket.on('chat:message_read', (data) => {
  console.log('Message read:', data);
  // data = { messageId: string, readBy: string }
});

5. Error Handling
Event: error
typescriptsocket.on('error', (error) => {
  console.error('Socket error:', error.message);
  // Show error notification to user
});
```

---

## üåê REST API Endpoints

### 1. **Start/Get Private Chat**
**Endpoint:** `POST /chat/private`

**Headers:**
```
Authorization: Bearer {jwt_token}
Request Body:
typescript{
  otherUserId: string;  // UUID of the other user
}
Response:
typescript{
  id: string;           // Chat ID
  type: "INDIVIDUAL";
  createdById: string;
  participants: Array<{
    userId: string;
    user: {
      id: string;
      profile: {
        name: string;
        avatarUrl: string | null;
      };
    };
  }>;
}
```

---

### 2. **Get My Chats**
**Endpoint:** `GET /chat/my`

**Headers:**
```
Authorization: Bearer {jwt_token}
Response:
typescriptArray<{
  id: string;
  type: "INDIVIDUAL";
  participants: Array<{
    userId: string;
    user: {
      id: string;
      profile: {
        name: string;
        avatarUrl: string | null;
      };
    };
  }>;
  messages: Array<{
    id: string;
    content: string;
    createdAt: string;
    senderId: string;
  }>;
  unread: number;  // Unread message count
}>
```

---

### 3. **Get Chat Messages (Paginated)**
**Endpoint:** `GET /chat/:chatId/messages`

**Headers:**
```
Authorization: Bearer {jwt_token}
Query Parameters:

cursor (optional): Message ID for pagination

Response:
typescriptArray<{
  id: string;
  chatId: string;
  content: string;
  mediaUrl: string | null;
  mediaType: string | null;
  senderId: string;
  createdAt: string;
  sender: {
    id: string;
    profile: {
      name: string;
      avatarUrl: string | null;
    };
  };
  readBy: Array<{
    userId: string;
  }>;
}>

üíª Implementation Example
React/TypeScript Example
typescriptimport { io, Socket } from 'socket.io-client';
import { useEffect, useState } from 'react';

const ChatComponent = () => {
  const [socket, setSocket] = useState<Socket | null>(null);
  const [messages, setMessages] = useState<any[]>([]);

  useEffect(() => {
    // Initialize socket connection
    const newSocket = io('ws://localhost:5056/chat', {
      auth: {
        token: localStorage.getItem('jwt_token')
      }
    });

    setSocket(newSocket);

    // Listen for incoming messages
    newSocket.on('chat:message_receive', (message) => {
      setMessages(prev => [...prev, message]);
    });

    // Listen for sent message confirmation
    newSocket.on('chat:message_sent', (message) => {
      setMessages(prev => [...prev, message]);
    });

    // Handle errors
    newSocket.on('error', (error) => {
      console.error('Chat error:', error);
    });

    return () => {
      newSocket.close();
    };
  }, []);

  const sendMessage = (receiverId: string, content: string) => {
    if (!socket) return;

    socket.emit('chat:message_send', {
      receiverId,
      content,
      mediaUrl: null,
      mediaType: null
    });
  };

  const markAsRead = (messageId: string) => {
    if (!socket) return;
    socket.emit('chat:message_read', { messageId });
  };

  return (
    // Your chat UI here
  );
};

üìù Important Notes

Authentication Required: All endpoints and socket connections require valid JWT authentication
Auto Chat Creation: If a chat doesn't exist between two users, it will be created automatically when sending the first message
User Verification: The system verifies that users are participants before allowing message sends
Real-time Updates: Both sender and receiver get instant updates via WebSocket events
Message Persistence: All messages are stored in the database and can be retrieved via REST API
Pagination: Use the cursor parameter for efficient message loading (default: 20 messages per request)
Unread Counts: The /chat/my endpoint includes unread message counts for each chat
Media Support: Messages can include images, videos, audio, or files via mediaUrl and mediaType


üîç Media Types
Supported values for mediaType:

"IMAGE"
"VIDEO"
"AUDIO"
"FILE"
null (for text-only messages)



Connection Issues:

Verify JWT token is valid and included in socket auth
Check WebSocket endpoint URL is correct
Ensure CORS is properly configured

Messages Not Received:

Confirm both users are connected to the socket
Verify receiverId is correct
Check network tab for socket events


