name: 🚀 CD Pipeline

on:
  # workflow_run:
  #   workflows: ["CI Pipeline"]
  #   types:
  #     - completed
  push:
    branches:
      - sabbir
      - main
jobs:
  build-and-push:
    name: Build & Push Docker Image 🏗️
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code 📥
        uses: actions/checkout@v4

      - name: Log in to Docker Hub 🔑
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Extract Package Name & Version 📦
        id: package
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name");
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_ENV

      - name: Build Docker Image 🔨
        run: docker compose --profile prod build

      - name: Push Docker Image 🚀
        run: |
          docker compose --profile prod push
          echo "✅ Docker image with version v${package_version} pushed!"

  # Deploy to VPS 🖥️
  deploy:
    name: Deploy to VPS 🌐
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout Repo 📥
        uses: actions/checkout@v4

      # Uncomment below to deploy to VPS via SSH
      # - name: Deploy to VPS via SSH 🛠️
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.VPS_HOST }}
      #     username: root
      #     password: ${{ secrets.VPS_PASSWORD }}
      #     script: |
      #       docker compose down --remove-orphans
      #       docker compose rm -f
      #       docker compose pull
      #       docker compose up -d
      #       docker image prune -f

      # Uncomment below for temporary DB reset if needed
      # - name: Reset DB Inside Container 🔄
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.VPS_HOST }}
      #     username: root
      #     password: ${{ secrets.VPS_PASSWORD }}
      #     script: |
      #       docker compose down
      #       docker compose rm -f
      #       docker volume rm $(docker volume ls -qf dangling=true)
      #       docker compose up -d
      #       sleep 20
      #       docker exec jesus-server-api npx prisma migrate reset --force --skip-generate --skip-seed
