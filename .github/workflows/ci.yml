name: CI Pipeline

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["**"]

jobs:
    setup:
        uses: ./.github/workflows/setup.yaml

    lint-test:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup and load environment
              uses: ./.github/actions/setup-and-load-env

            - name: ğŸ§¹ Run Lint
              run: pnpm ci:fix

            - name: âœ… Format Check
              run: pnpm format

            - name: ğŸ”„ Generate Prisma Client
              run: pnpm prisma:generate

            - name: ğŸ— Build Project
              run: pnpm build

            - name: ğŸ§¹ Clean up .env
              if: always()
              run: rm -f "${{ github.workspace }}/.env"

    build-and-push:
        needs: lint-test
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup and load environment
              uses: ./.github/actions/setup-and-load-env

            - name: ğŸ“‹ Verify environment variables
              uses: ./.github/actions/verify-env

            - name: Log in to Docker Hub ğŸ”‘
              uses: ./.github/actions/docker-login

            - name: Build Docker Image ğŸ”¨
              run: |
                  echo "Building Docker image: $IMAGE_TAG"
                  docker compose --profile prod build
                  if [ $? -eq 0 ]; then echo "âœ… Docker image built successfully"; else echo "âŒ Failed to build Docker image"; exit 1; fi

            - name: Push Docker Image ğŸš€
              run: |
                  echo "Pushing Docker image: $IMAGE_TAG"
                  docker compose --profile prod push
                  if [ $? -eq 0 ]; then echo "âœ… Docker image $IMAGE_TAG pushed successfully!"; else echo "âŒ Failed to push Docker image"; exit 1; fi
