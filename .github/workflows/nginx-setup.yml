name: ðŸš€ Deploy NGINX HTTPS Reverse Proxy ðŸ”

on:
  workflow_run:
    workflows: ["ðŸš€ CD Pipeline with Zero Downtime"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ§  Extract the package name
        id: package
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")

          echo "ðŸ“¦ PACKAGE_NAME: $PACKAGE_NAME"
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Outputs written to GITHUB_OUTPUT"

      - name: Setup SSH ðŸ”
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

          cat > ~/.ssh/config << EOF
          Host deploy-server
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SSH Connection ðŸš€
        run: ssh deploy-server "echo 'SSH connection successful'"

      - name: âš™ï¸ Prepare and update NGINX .env values on VPS
        run: |
          echo "ðŸ›  Updating NGINX-related env vars on VPS"

          ssh -i deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "bash -s" <<EOF
            set -e

            cd ~/${{ steps.package.outputs.package_name }}

            touch .env

            update_var() {
              KEY=\$1
              VALUE=\$2
              if grep -qE "^\\\$KEY=" .env; then
                sed -i "s|^\\\$KEY=.*|\\\$KEY=\\\$VALUE|" .env
                echo "ðŸ”„ Updated: \$KEY"
              else
                echo "\$KEY=\$VALUE" >> .env
                echo "âž• Added: \$KEY"
              fi
            }

            update_var BASE_URL "${{ secrets.BASE_URL }}"
            update_var EMAIL "${{ secrets.EMAIL }}"
            update_var DOCKER_USERNAME "${{ secrets.DOCKER_USERNAME }}"

            echo "âœ… .env updated on VPS"
          EOF

      - name: Debug the scripts directory
        run: ls -al ./scripts

      - name: ðŸ§ª Run NGINX Setup Script on VPS
        run: |
          echo "ðŸš€ Preparing to run setup-nginx.sh on VPS"

          PACKAGE_NAME=${{ steps.package.outputs.package_name }}

          ssh deploy-server "bash -s" <<EOF
            set -e
            cd ~/\$PACKAGE_NAME

            if [ ! -f scripts/setup-nginx.sh ]; then
              echo "âŒ scripts/setup-nginx.sh not found. Will copy from runner."
              exit 10
            else
              echo "âœ… setup-nginx.sh found on VPS"
            fi
          EOF

          # Check exit code; if 10, then copy scripts directory
          if [ $? -eq 10 ]; then
            echo "ðŸ“¤ Copying scripts directory to VPS..."
            scp -r ./scripts deploy-server:~/${{ steps.package.outputs.package_name }}/
          fi

          echo "ðŸš€ Running setup-nginx.sh on VPS..."
          ssh deploy-server "cd ~/${{ steps.package.outputs.package_name }}/scripts && chmod +x setup-nginx.sh && ./setup-nginx.sh"
