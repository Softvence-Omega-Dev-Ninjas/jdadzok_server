name: 🚀 CD Pipeline with Zero Downtime

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  build-and-push:
    name: Build & Push Docker Image 🏗️
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}

    outputs:
      package_name: ${{ steps.extract.outputs.package_name }}
      package_version: ${{ steps.extract.outputs.package_version }}
      image_tag: ${{ steps.extract.outputs.image_tag }}

    steps:
      - name: Validate Required Secrets 🔐
        run: |
          echo "🔍 Validating required secrets and environment..."
          MISSING_SECRETS=0

          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "❌ DOCKER_USERNAME secret is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "✅ DOCKER_USERNAME secret is configured"
          fi

          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "❌ DOCKER_PASSWORD secret is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "✅ DOCKER_PASSWORD secret is configured"
          fi

          if [ $MISSING_SECRETS -gt 0 ]; then
            echo "❌ $MISSING_SECRETS required secret(s) are missing"
            exit 1
          fi

          echo "✅ All required secrets are properly configured"

      - name: Checkout Code 📥
        uses: actions/checkout@v4

      - name: Set up NodeJs
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Set Package Info 📦
        id: extract
        run: |
          echo "📦 Using Docker image information..."
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          IMAGE_TAG="${{secrets.DOCKER_USERNAME}}/$PACKAGE_NAME:$PACKAGE_VERSION"

          echo "=== IMAGE INFO ==="
          echo "PACKAGE_NAME: $PACKAGE_NAME"
          echo "PACKAGE_VERSION: $PACKAGE_VERSION"
          echo "IMAGE_TAG: $IMAGE_TAG"
          echo "=================="

          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "✅ Outputs written to GITHUB_OUTPUT"

      - name: Log in to Docker Hub 🔑
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "🔑 Logging into Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          echo "✅ Successfully logged into Docker Hub"

      - name: Create .env file 📄
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "📄 Creating .env file for Docker build..."
          echo "PACKAGE_VERSION=${{ steps.extract.outputs.package_version }}" >> .env
          echo "PACKAGE_NAME=${{ steps.extract.outputs.package_name }}" >> .env
          echo "DOCKER_USERNAME=$DOCKER_USERNAME" >> .env
          echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}" >> .env
          echo "BASE_URL=${{ secrets.BASE_URL }}" >> .env
          echo "MAIL_USER=${{ secrets.MAIL_USER }}" >> .env
          echo "EMAIL=${{ secrets.EMAIL }}" >> .env
          echo "MAIL_PASS=${{ secrets.MAIL_PASS }}" >> .env
          echo "SUPER_ADMIN_EMAIL=${{ secrets.SUPER_ADMIN_EMAIL }}" >> .env
          echo "SUPER_ADMIN_PASS=${{ secrets.SUPER_ADMIN_PASS }}" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> .env
          echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> .env
          echo "TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}" >> .env
          # aws
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} " >> .env
          echo "AWS_S3_BUCKET_NAME=${{secrets.AWS_S3_BUCKET_NAME}}" >> .env

      - name: Build Docker Image 🔨
        run: |
          echo "Building Docker image: ${{ steps.extract.outputs.image_tag }}"
          docker compose --profile prod build
          if [ $? -eq 0 ]; then
            echo "✅ Docker image built successfully"
          else
            echo "❌ Failed to build Docker image"
            exit 1
          fi

      - name: Push Docker Image 🚀
        run: |
          echo "Pushing Docker image: ${{ steps.extract.outputs.image_tag }}"
          docker compose --profile prod push
          if [ $? -eq 0 ]; then
            echo "✅ Docker image ${{ steps.extract.outputs.image_tag }} pushed successfully!"
          else
            echo "❌ Failed to push Docker image"
            exit 1
          fi

      - name: Clean up .env 🧹
        if: always()
        run: rm -f .env

  deploy:
    name: Deploy to VPS with Zero Downtime 🔄
    needs: build-and-push
    runs-on: ubuntu-latest
    if: ${{ success() && needs.build-and-push.result == 'success' }}

    steps:
      - name: Checkout Code 📥
        uses: actions/checkout@v4

      - name: Verify Build Outputs 🔍
        run: |
          echo "🔍 Verifying build job outputs..."
          echo "=== BUILD JOB OUTPUTS ==="
          echo "package_name: '${{ needs.build-and-push.outputs.package_name }}'"
          echo "package_version: '${{ needs.build-and-push.outputs.package_version }}'"
          echo "image_tag: '${{ needs.build-and-push.outputs.image_tag }}'"
          if [ -z "${{ needs.build-and-push.outputs.image_tag }}" ]; then
            echo "⚠️ IMAGE_TAG is empty, using hardcoded fallback in deployment"
          else
            echo "✅ IMAGE_TAG is set to '${{ needs.build-and-push.outputs.image_tag }}'"
          fi
          echo "========================="

      - name: Setup SSH 🔐
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          cat <<EOF > ~/.ssh/config
          Host deploy-server
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Create .env file 📄
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "📄 Creating deployment .env file..."
          echo "PACKAGE_VERSION=\"${{ needs.build-and-push.outputs.package_version }}\"" >> .env
          echo "PACKAGE_NAME=\"${{ needs.build-and-push.outputs.package_name }}\"" >> .env
          echo "DOCKER_USERNAME=\"$DOCKER_USERNAME\"" >> .env
          echo "NODE_ENV=\"${{ secrets.NODE_ENV }}\"" >> .env
          echo "DATABASE_URL=\"${{ secrets.DATABASE_URL }}\"" >> .env
          echo "JWT_SECRET=\"${{ secrets.JWT_SECRET }}\"" >> .env
          echo "JWT_EXPIRES_IN=\"${{ secrets.JWT_EXPIRES_IN }}\"" >> .env
          echo "BASE_URL=\"${{ secrets.BASE_URL }}\"" >> .env
          echo "MAIL_USER=\"${{ secrets.MAIL_USER }}\"" >> .env
          echo "EMAIL=\"${{ secrets.EMAIL }}\"" >> .env
          echo "MAIL_PASS=\"${{ secrets.MAIL_PASS }}\"" >> .env
          echo "SUPER_ADMIN_EMAIL=\"${{ secrets.SUPER_ADMIN_EMAIL }}\"" >> .env
          echo "SUPER_ADMIN_PASS=\"${{ secrets.SUPER_ADMIN_PASS }}\"" >> .env
          echo "REDIS_URL=\"${{ secrets.REDIS_URL }}\"" >> .env
          echo "TWILIO_ACCOUNT_SID=\"${{ secrets.TWILIO_ACCOUNT_SID }}\"" >> .env
          echo "TWILIO_AUTH_TOKEN=\"${{ secrets.TWILIO_AUTH_TOKEN }}\"" >> .env
          echo "TWILIO_PHONE_NUMBER=\"${{ secrets.TWILIO_PHONE_NUMBER }}\"" >> .env

          # for aws
          echo "AWS_REGION=\"${{ secrets.AWS_REGION }}\"" >> .env
          echo "AWS_ACCESS_KEY_ID=\"${{ secrets.AWS_ACCESS_KEY_ID }}\"" >> .env
          echo "AWS_SECRET_ACCESS_KEY=\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\"" >> .env
          echo "AWS_S3_BUCKET_NAME=\"${{secrets.AWS_S3_BUCKET_NAME}}\"" >> .env

          # for nginx
          echo "EMAIL=\"${{secrets.EMAIL}}\"" >> .env
          echo "BASE_URL=\"${{secrets.BASE_URL}}\"" >> .env

      - name: Copy Files to Server 📦
        run: |
          echo "Creating directories..."
          ssh deploy-server "mkdir -p ~/${{ needs.build-and-push.outputs.package_name }}/scripts"

          echo "Copying files..."
          scp -i ~/.ssh/deploy_key docker-compose.yaml ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/${{ needs.build-and-push.outputs.package_name }}/
          scp -i ~/.ssh/deploy_key .env ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/${{ needs.build-and-push.outputs.package_name }}/
          scp -i ~/.ssh/deploy_key Dockerfile ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/${{ needs.build-and-push.outputs.package_name }}/
          scp -i ~/.ssh/deploy_key scripts/deploy.sh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/${{ needs.build-and-push.outputs.package_name }}/scripts/
          scp -i ~/.ssh/deploy_key scripts/setup-nginx.sh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/${{ needs.build-and-push.outputs.package_name }}/scripts/

          ssh deploy-server "chmod +x ~/${{ needs.build-and-push.outputs.package_name }}/scripts/deploy.sh"
          echo "✅ Files copied successfully"

      - name: Deploy Application 🚀
        run: |
          echo "Starting deployment..."
          echo "Package: ${{ needs.build-and-push.outputs.package_name }}"
          echo "Version: ${{ needs.build-and-push.outputs.package_version }}"

          ssh deploy-server bash << 'DEPLOY_EOF'
          set -e

          # Set variables
          PACKAGE_NAME="${{ needs.build-and-push.outputs.package_name }}"
          PACKAGE_VERSION="${{ needs.build-and-push.outputs.package_version }}"

          echo "=== DEPLOYMENT STARTED ==="
          echo "Package: $PACKAGE_NAME"
          echo "Version: $PACKAGE_VERSION"
          echo "=============================="

          cd ~/$PACKAGE_NAME

          # Basic system setup (only if needed)
          # Install Docker Compose if needed
          if [ ! -f ~/.docker/cli-plugins/docker-compose ]; then
            echo "Installing Docker Compose..."
            mkdir -p ~/.docker/cli-plugins/
            curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
            chmod +x ~/.docker/cli-plugins/docker-compose
          fi

          # Login to Docker Hub
          echo "Logging into Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

          # Source environment variables
          if [ -f .env ]; then
            echo "Sourcing .env file..."
            source .env
          else
            echo "❌ .env file not found"
            exit 1
          fi

          # Run the simplified deployment script
          echo "Executing zero-downtime deployment..."
          if ./scripts/deploy.sh --version "$PACKAGE_VERSION"; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed - automatic rollback should have occurred"
            exit 1
          fi

          # Cleanup
          docker logout
          docker image prune -f

          echo "🎉 DEPLOYMENT COMPLETED SUCCESSFULLY!"
          DEPLOY_EOF

      - name: Verify Deployment ✅
        run: |
          echo "Verifying deployment..."
          ssh deploy-server bash << 'VERIFY_EOF'
          PACKAGE_NAME="${{ needs.build-and-push.outputs.package_name }}"
          cd ~/$PACKAGE_NAME

          echo "=== Running deployment status check ==="
          ./scripts/deploy.sh status

          echo "=== Testing endpoint directly ==="
          if curl -f -s --connect-timeout 5 --max-time 10 "http://localhost:5056/" | grep -q '"status":"ok"'; then
            echo "🎉 Endpoint health check passed! Service is responding with status: ok"
          else
            echo "❌ Endpoint health check failed!"
            exit 1
          fi

          echo "=== Final verification ==="
          echo "Deployment verified successfully!"
          VERIFY_EOF

      - name: Cleanup 🧹
        if: always()
        run: |
          rm -rf ~/.ssh/deploy_key* ~/.ssh/config
          rm -f .env
